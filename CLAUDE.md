<!-- OPENSPEC:START -->
# OpenSpec Instructions

These instructions are for AI assistants working in this project.

Always open `@/openspec/AGENTS.md` when the request:
- Mentions planning or proposals (words like proposal, spec, change, plan)
- Introduces new capabilities, breaking changes, architecture shifts, or big performance/security work
- Sounds ambiguous and you need the authoritative spec before coding

Use `@/openspec/AGENTS.md` to learn:
- How to create and apply change proposals
- Spec format and conventions
- Project structure and guidelines

Keep this managed block so 'openspec update' can refresh the instructions.

<!-- OPENSPEC:END -->

# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## üìñ Documentation Navigation

**New to the project? Start here:**
- [Documentation Index](./docs/INDEX.md) - Complete navigation and quick links
- [Homelab Services Docs](./homelab-services/docs/INDEX.md) - Monorepo documentation

**Key Documentation:**
- **Architecture**: Service-specific guides in [`docs/`](./docs/) (DNS, Home Assistant, Coolify, etc.)
- **OpenSpec Specifications**: Formal specs in [`openspec/specs/`](./openspec/specs/)
- **Homelab Services**: Better-T-Stack monorepo docs in [`homelab-services/docs/`](./homelab-services/docs/)

## Repository Overview

Personal dotfiles and homelab infrastructure automation for macOS and Arch Linux environments. Two main components:

1. **Mac Setup** (`/mac`) - macOS dotfiles, Homebrew packages, system configuration
2. **Homelab Stack** (`/homelab`) - Docker-based self-hosted services for Arch Linux server

## Architecture Summary

### Homelab (Primary Component)

**Deployment**: CI/CD via self-hosted GitHub Actions runners on Arch Linux server

**Network**: Two isolated Docker networks
- `homelab` (172.20.0.0/16) - Core infrastructure (Home Assistant, DNS, AI, security)
- `media` (172.21.0.0/16) - Media services with VPN-protected downloads

**Management**: `homelab/homelab.sh` - Complete setup wizard and interactive menu

**State**: `.setup_state` file tracks wizard progress for resumable setup

### Mac Setup

**Entry Point**: `mac/install.sh` - Interactive installer for Homebrew, packages, dotfiles, and macOS defaults

## Essential Commands

### Homelab Management

```bash
# First-time setup (mandatory wizard)
cd homelab && ./homelab.sh

# Service management
./homelab.sh start [service]    # Start all or specific service
./homelab.sh stop                # Stop all services
./homelab.sh restart [service]   # Restart services
./homelab.sh status              # Show container status
./homelab.sh logs [service]      # View logs

# Maintenance
./homelab.sh update              # Pull latest Docker images
./homelab.sh backup              # Create configuration backup
./homelab.sh deploy              # Trigger GitHub Actions deployment

# Direct deployment (used by CI)
cd homelab/scripts
bash deploy-ci-streamlined.sh    # Streamlined deployment
```

### Mac Setup

```bash
cd mac && ./install.sh           # Run interactive installer
```

## Key Configuration Files

### Homelab

- `docker-compose.yml` - Main orchestrator with includes
- `compose/*.yml` - Service definitions (infrastructure, media, AI, monitoring, etc.)
- `.env` - Environment variables (auto-generated by wizard)
- `traefik/traefik.yml` - Static Traefik configuration
- `traefik/dynamic/*.yml` - Dynamic routes, middlewares, TLS

### Mac

- `homebrew/Brewfile` - Homebrew packages
- `zsh/.zshrc` - Zsh configuration
- `wezterm/wezterm.lua` - Terminal config
- `starship/starship.toml` - Prompt config

## Quick Troubleshooting

### Homelab Issues

**Service won't start:**
```bash
./homelab.sh logs <service>
docker compose ps <service>
```

**Permission errors:** Handled automatically by deployment scripts

**GitHub Runner issues:**
```bash
cd ~/actions-runner
sudo ./svc.sh status
sudo ./svc.sh restart
```

**DNS not resolving:**
```bash
# Check AdGuard status
docker compose ps adguardhome
docker compose logs adguardhome

# Test fallback
dig @1.1.1.1 google.com
```

### Mac Issues

**Build failures:**
```bash
cd mac && ./install.sh  # Re-run installer
```

## Documentation by Service

| Service | Documentation | OpenSpec Spec |
|---------|--------------|---------------|
| **DNS Configuration** | [docs/dns/](./docs/dns/) | [specs/dns-configuration](./openspec/specs/dns-configuration/) |
| **Home Assistant** | [docs/home-assistant/](./docs/home-assistant/) | [specs/home-assistant-integration](./openspec/specs/home-assistant-integration/) |
| **Coolify PaaS** | [docs/coolify/](./docs/coolify/) | [specs/coolify-paas](./openspec/specs/coolify-paas/) |
| **Deployment** | [docs/deployment/](./docs/deployment/) | [specs/deployment-orchestration](./openspec/specs/deployment-orchestration/) |
| **GitHub Actions** | [docs/github-actions/](./docs/github-actions/) | [specs/github-actions-workflows](./openspec/specs/github-actions-workflows/) |
| **Mac Setup** | [mac/README.md](./mac/README.md) | [specs/mac-development-environment](./openspec/specs/mac-development-environment/) |
| **Bluetooth** | CLAUDE.md (archived) | [specs/bluetooth-automation](./openspec/specs/bluetooth-automation/) |
| **Claude Agent** | [homelab-services/docs/](./homelab-services/docs/) | [specs/claude-agent-management](./openspec/specs/claude-agent-management/) |
| **Playwright Server** | [homelab-services/docs/](./homelab-services/docs/) | [specs/playwright-report-server](./openspec/specs/playwright-report-server/) |
| **Error Automation** | CLAUDE.md (see below) | N/A |
| **Multi-Runner** | CLAUDE.md (archived) | [specs/multi-runner-orchestration](./openspec/specs/multi-runner-orchestration/) |
| **Steam Gaming** | CLAUDE.md (archived) | [specs/steam-gaming-setup](./openspec/specs/steam-gaming-setup/) |
| **USB Boot** | CLAUDE.md (archived) | [specs/usb-boot-automation](./openspec/specs/usb-boot-automation/) |

## Homelab Services (Better-T-Stack Monorepo)

The `homelab-services/` directory contains a Better-T-Stack monorepo with type-safe applications:

**Applications:**
- **Claude Agent** (port 3002) - Claude Code session management
- **Playwright Server** (port 3000) - Test report aggregation

**Documentation:**
- [Architecture Guide](./homelab-services/docs/architecture.md) - Better-T-Stack design
- [Development Guide](./homelab-services/docs/development.md) - Setup and workflows
- [Contributing Guide](./homelab-services/docs/contributing.md) - Code standards
- [Deployment Guide](./homelab-services/docs/deployment.md) - Docker builds and CI/CD
- [Documentation Index](./homelab-services/docs/INDEX.md) - Complete navigation

## Unified Work Dashboard

The Claude Agent Web application includes a unified dashboard for managing OpenSpec changes, work queue, and agent coordination. Access at `http://localhost:3002/dashboard`.

**OpenSpec Reference:** [specs/unified-work-dashboard](./openspec/specs/unified-work-dashboard/)

### Dashboard Navigation

The dashboard is organized into four main tabs:

1. **Work Queue** - View and manage all work items (specs + error proposals)
2. **Approvals** - Review and approve/reject specs in proposing and review states
3. **Master Agents** - Monitor active worker agents and view clarifications
4. **Lifecycle** - Visualize spec state transitions and history

**Tab Persistence:** The active tab is persisted to the URL (e.g., `?tab=work-queue`) for easy bookmarking and sharing.

### Work Queue Tab

Manage all work items in a unified table with drag-and-drop prioritization.

**Features:**
- **Combined View:** Specs and error proposals in one table
- **Sortable Columns:** Priority, Age, Status (click headers to sort)
- **Type Badges:** Blue "Spec" (manual), Red "Error" (auto-generated)
- **Status Badges:** queued, assigned, blocked, completed
- **Priority Display:** 1-5 star icons
- **Real-time Updates:** New items and status changes appear instantly via tRPC subscriptions

**Actions:**
- **View** (Eye icon) - Navigate to lifecycle page
- **Edit** (Edit icon) - Open spec editor
- **Approve** (CheckCircle2) - Move from proposing ‚Üí approved (shows for queued items)
- **Assign to Me** (UserPlus) - Assign work item to your session
- **Complete** (Manual) - Mark as done (shows for assigned items)
- **Reject** (XCircle) - Archive spec with reason

**Drag-and-Drop Reordering:**
- Click and hold the grip icon (‚â°) on any row
- Drag to new position
- Release to reorder (syncs to server immediately)
- Optimistic UI updates with rollback on error

### Approvals Tab

Review specs waiting for user approval or validation.

**Two Sections:**

1. **Needs Approval** (proposing state)
   - Specs awaiting initial review before work starts
   - View full proposal.md content (rendered markdown)
   - View tasks.md checklist
   - Actions: View, Approve, Edit, Reject

2. **Needs Validation** (review state)
   - Specs completed by workers, awaiting confirmation
   - View tasks.md with completion status
   - View proposal.md for reference
   - Actions: View, Validate & Apply

**Approval Workflow:**
1. Click "View" on any spec to open detail modal
2. Review proposal content and tasks
3. **Approve:** Adds to work queue (transitions proposing ‚Üí approved)
4. **Edit & Approve:** Navigate to spec editor, save changes, then approve
5. **Reject:** Provide reason, archives spec (transitions proposing ‚Üí archived)

**Validation Workflow:**
1. Worker completes spec (transitions in_progress ‚Üí review)
2. User reviews completed tasks in validation section
3. **Validate & Apply:** Marks spec as applied (transitions review ‚Üí applied)
4. **Request Changes:** Send feedback to agent (placeholder for future implementation)

**Real-time Updates:** New specs automatically appear when they enter proposing or review states via lifecycle subscriptions.

### Master Agents Tab

Monitor active worker agents spawned by master sessions.

**Worker Cards Display:**
- **Agent Type Badge:** T3 Stack, E2E Tests, Database, UX Design, Docker, Redis, General
- **Status Badge:** Spawned (blue), Working (green), Completed (gray), Failed (red), Cancelled (gray)
- **Spec Info:** Spec ID link, Session ID
- **Time Elapsed:** "Started 5m ago" or "Spawned 10s ago"
- **Progress Bar:** Shows completion percentage for active workers
- **Error Messages:** Displayed for failed workers

**Actions:**
- **Cancel** (Square icon) - Stop active worker
- **Retry** (Zap icon) - Restart failed worker
- **View Details** (Activity icon) - Open worker detail modal

**Worker Detail Modal:**
- **Progress Metrics:** Tools executed, success rate, files changed, tests run
- **Timing:** Spawned, started, completed timestamps
- **Hook Timeline:** Last 50 tool events with names and results
- **Files Changed:** List of modified files during execution
- **Error Details:** Full error message for failed workers

**Clarifications Panel:**
- Placeholder for future implementation
- Will display pending questions from workers requiring user input
- Empty state: "No pending clarifications"

**Real-time Updates:** Worker events (spawned, completed, failed) trigger toast notifications and automatic UI refresh via workerAgent subscriptions.

### Lifecycle Tab

Visualize spec state transitions and history with an interactive timeline.

**Features:**
- **Spec Selector:** Dropdown to choose which spec to visualize
- **Timeline View:** Vertical timeline showing all state transitions
- **State Badges:** Color-coded badges for each lifecycle state
  - proposing (blue), approved (gray), assigned (gray), in_progress (yellow), review (orange), applied (green), archived (gray)
- **Triggered By Icons:** User (üë§), Worker (ü§ñ), System (‚öôÔ∏è)
- **Transition Details:** From/to states, timestamp, notes
- **Duration Display:** Time spent in each state
- **Task Completion:** Progress bar showing overall task completion percentage

**Lifecycle States:**
1. **proposing** - Awaiting user approval
2. **approved** - Added to work queue
3. **assigned** - Linked to a session
4. **in_progress** - Worker actively executing
5. **review** - Worker completed, awaiting validation
6. **applied** - User validated and marked as done
7. **archived** - Rejected or superseded

**Real-time Updates:** Timeline refreshes when the selected spec changes state via lifecycle subscriptions.

### Filter Sidebar

Shared filtering controls across all tabs (persists across navigation).

**Available Filters:**
- **Project Dropdown:** Single-select project filter
- **Status Multi-select:** Checkbox filters for lifecycle states
- **Priority Range Slider:** Filter by priority (1-5)
- **Date Range Picker:** From/to date selection
- **Search Input:** Text search across spec titles
- **Apply Filters / Reset Buttons:** Apply changes or clear all filters

**Note:** Not all filters apply to all tabs (e.g., lifecycle tab uses spec selector instead of general filters).

### Stats Cards

Dashboard header shows aggregate statistics:
- **Total Specs:** Count of all OpenSpec changes
- **Active Work:** Number of items in work queue
- **Pending Approvals:** Specs awaiting review (proposing + review states)
- **Error Proposals:** Auto-generated proposals from test failures

Stats auto-refresh when data changes via query invalidation.

### Keyboard Shortcuts (Spec Editor)

The Monaco-based spec editor supports standard keyboard shortcuts:
- **Ctrl/Cmd + S:** Save current file
- **Ctrl/Cmd + F:** Find in file
- **Ctrl/Cmd + H:** Find and replace
- **Ctrl/Cmd + /:** Toggle line comment
- **Alt + Up/Down:** Move line up/down
- **Ctrl/Cmd + D:** Add selection to next find match
- **Ctrl/Cmd + Shift + K:** Delete line
- **Ctrl/Cmd + Z:** Undo
- **Ctrl/Cmd + Shift + Z:** Redo

**Editor Tabs:**
- **Proposal:** Edit proposal.md (required sections: Why, What Changes, Impact)
- **Tasks:** Edit tasks.md with live task completion percentage
- **Design:** Edit design.md (optional, create via "Create Design" button if missing)

**Save Options:**
- **Save:** Updates spec content and syncs to filesystem
- **Save & Approve:** Saves then approves (shows for proposing specs)
- **Cancel:** Discard changes with confirmation if unsaved

### Common Workflows

**Approving a New Spec:**
1. Navigate to **Approvals** tab
2. Find spec in "Needs Approval" section
3. Click "View" to review proposal and tasks
4. Click "Approve" to add to work queue
5. Spec moves to **Work Queue** tab automatically

**Assigning Work to Your Session:**
1. Navigate to **Work Queue** tab
2. Find queued item
3. Click "Assign to Me"
4. Worker automatically spawned (visible in **Master Agents** tab)

**Validating Completed Work:**
1. Navigate to **Approvals** tab
2. Find spec in "Needs Validation" section
3. Click "View" to review completed tasks
4. Click "Validate & Apply"
5. Spec marked as applied and archived

**Monitoring Worker Progress:**
1. Navigate to **Master Agents** tab
2. View active worker cards
3. Check progress bars and status
4. Click "View Details" for metrics and tool timeline
5. Cancel if needed or let worker complete

**Editing a Spec:**
1. From any tab, click "Edit" on a spec
2. Opens Monaco editor with Proposal/Tasks/Design tabs
3. Make changes in markdown
4. Click "Save" or "Save & Approve"
5. Changes sync to filesystem immediately

### Real-time Features

All dashboard tabs use tRPC subscriptions for live updates:
- **Work Queue:** New items, status changes, reordering
- **Approvals:** State transitions (proposing, review, applied)
- **Master Agents:** Worker spawned, completed, failed events
- **Lifecycle:** State changes for selected spec
- **Errors:** New error proposals, priority escalation

**Toast Notifications:** Important events trigger toast messages (top-right):
- "New spec awaiting approval"
- "Worker spawned: T3 Stack"
- "Worker completed: worker-abc123"
- "Spec approved and added to work queue"
- "Work item removed from queue"

### Troubleshooting

**Dashboard not loading:**
```bash
cd homelab-services/apps/claude-agent-web
bun run dev  # Start dev server on port 3002
```

**Subscriptions not updating:**
- Check browser console for WebSocket errors
- Verify tRPC server is running
- Refresh page to reconnect

**Worker detail modal empty:**
- Worker data may not have progress metrics yet
- Check if worker has started executing tools
- Completed workers retain full history

**Spec editor not saving:**
- Check file permissions on openspec/changes/
- Verify spec ID exists
- Check server logs for sync errors

**Drag-and-drop not working:**
- Ensure @dnd-kit packages installed
- Check for JavaScript errors in console
- Try refreshing page

### Notes for Claude Code

- Dashboard uses tRPC for type-safe client-server communication
- All mutations automatically invalidate relevant queries
- tRPC subscriptions handle cleanup on component unmount
- Monaco editor loaded via dynamic import to avoid SSR issues
- E2E tests available in `apps/claude-agent-web/e2e/dashboard.spec.ts`
- Real-time updates use EventEmitter with tRPC observables
- Filter state not yet persisted to localStorage (future enhancement)

## Error-to-Spec Auto-Generation

The `homelab-services` monorepo includes an automated error detection and proposal generation system that converts Playwright test failures into actionable OpenSpec change proposals.

### How It Works

1. **Failure Detection**: FailureWatcher service polls for new test failures every 30 seconds
2. **Error Analysis**: Failures are classified by type (type-error, missing-property, assertion-failure, network-error, configuration-error)
3. **Proposal Generation**: Complete OpenSpec proposals are auto-generated with:
   - Title: `Fix: <test-name>`
   - Why section: Error details, classification, occurrence count
   - What Changes: Suggested fixes based on error type
   - Tasks: Step-by-step implementation checklist
4. **Priority Assignment**: Errors receive priority 1-5 based on classification and occurrence count
5. **Work Queue Integration**: Approved proposals automatically enter the work queue

### Priority Escalation

Errors automatically escalate in priority as they recur:

| Classification | Initial Priority | Escalation Trigger | Escalated Priority |
|---------------|------------------|--------------------|--------------------|
| **NEW** | 2 | 2+ occurrences | 3 (FLAKY level) |
| **FLAKY** | 3 | 3+ occurrences | 4 (RECURRING level) |
| **RECURRING** | 4 | 4+ occurrences | 5 (PERSISTENT level) |
| **PERSISTENT** | 5 | Always max | 5 |

### Error Proposals Dashboard

Access the dashboard at `http://localhost:3002/errors`

**Features:**
- **Filter Sidebar**: Search, classification filters, priority range slider
- **Real-Time Updates**: Automatic updates via tRPC subscriptions
- **Approve/Reject**: Review and approve proposals with one click
- **View Related**: See all historical failures for the same test
- **Statistics**: Track total proposals by classification and priority

**Workflow:**
1. Test fails ‚Üí Proposal auto-generated
2. Review proposal in dashboard
3. **Approve** ‚Üí Moves to work queue with assigned priority
4. **Reject** ‚Üí Archives proposal with rejection reason

### API Endpoints

Error proposals are managed via tRPC router at `packages/api/src/router/error-proposals.ts`:

**Queries:**
- `listPending` - Get pending error proposals (supports filtering, sorting, pagination)
- `get` - Get detailed proposal by ID
- `stats` - Get statistics by classification and priority
- `getRelatedFailures` - Get all failures for the same test

**Mutations:**
- `link` - Link proposal to existing spec
- `regenerate` - Regenerate proposal content

**Subscriptions:**
- `subscribe` - Real-time events: proposal_generated, proposal_updated, priority_escalated

### Database Schema

Error proposals are stored in the `error_proposals` table:

```typescript
{
  id: number
  testFailureId: number (FK to test_failures)
  specId: string (FK to openspec_specs)
  generatedAt: timestamp
  lastFailureAt: timestamp
  autoGeneratedContent: JSON (proposal content)
  userModified: boolean
  occurrenceCount: number
}
```

### Testing

**Unit Tests** (33 tests): `packages/api/src/utils/__tests__/error-analysis.test.ts`
- Error classification
- Message extraction
- Priority calculation
- File path extraction

**Integration Tests** (11 tests): `packages/api/src/services/__tests__/failure-watcher.integration.test.ts`
- Priority escalation flow
- Duplicate detection
- Work queue integration
- Full workflow simulation

**E2E Tests** (20+ scenarios): `apps/claude-agent-web/e2e/error-proposals.spec.ts`
- Dashboard rendering
- Filtering and searching
- Approve/reject workflows
- Real-time updates

### Key Files

| File | Purpose |
|------|---------|
| `packages/api/src/utils/error-analysis.ts` | Error classification and analysis utilities |
| `packages/api/src/services/error-proposal-generator.ts` | Proposal generation service |
| `packages/api/src/services/failure-watcher.ts` | Failure detection and polling |
| `packages/api/src/router/error-proposals.ts` | tRPC API router |
| `packages/db/src/schema/error-proposals.ts` | Database schema |
| `apps/claude-agent-web/src/app/(dashboard)/errors/page.tsx` | Dashboard UI |
| `apps/claude-agent-web/instrumentation.ts` | Server startup hook for watcher |

### Configuration

The FailureWatcher is initialized in `instrumentation.ts` and runs automatically when the Next.js server starts:

```typescript
{
  projectId: 1,
  projectPath: '/path/to/project',
  openspecPath: '/path/to/openspec',
  pollingInterval: 30000 // 30 seconds
}
```

### Notes for Claude Code

- Error proposals are **read-only** until approved/rejected by a user
- Duplicate detection uses test name + error message comparison
- Priority escalation updates both the proposal and work queue
- Real-time subscriptions use EventEmitter with tRPC observables
- Proposals create complete OpenSpec file structure (proposal.md, tasks.md)

## Getting Help

1. **Check documentation**: [Documentation Index](./docs/INDEX.md)
2. **Review OpenSpec specs**: [openspec/specs/](./openspec/specs/)
3. **Read archived details**: [openspec/changes/archive/](./openspec/changes/archive/)
4. **Search issues**: Check GitHub Issues for similar problems

## Notes for Claude Code

- **OpenSpec Changes**: Use `/openspec:proposal` for new capabilities, `/openspec:apply` to implement
- **Documentation**: Always check service-specific docs in `docs/` before making changes
- **Testing**: Use `openspec validate --strict` to validate specifications
- **State Management**: Respect `.setup_state` in homelab wizard for resumable operations
- **Archived Content**: Original detailed documentation preserved in `openspec/changes/archive/`
