<!-- OPENSPEC:START -->
# OpenSpec Instructions

These instructions are for AI assistants working in this project.

Always open `@/openspec/AGENTS.md` when the request:
- Mentions planning or proposals (words like proposal, spec, change, plan)
- Introduces new capabilities, breaking changes, architecture shifts, or big performance/security work
- Sounds ambiguous and you need the authoritative spec before coding

Use `@/openspec/AGENTS.md` to learn:
- How to create and apply change proposals
- Spec format and conventions
- Project structure and guidelines

Keep this managed block so 'openspec update' can refresh the instructions.

<!-- OPENSPEC:END -->

# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## ðŸ“– Documentation Navigation

**New to the project? Start here:**
- [Documentation Index](./docs/INDEX.md) - Complete navigation and quick links
- [Homelab Services Docs](./homelab-services/docs/INDEX.md) - Monorepo documentation

**Key Documentation:**
- **Architecture**: Service-specific guides in [`docs/`](./docs/) (DNS, Home Assistant, Coolify, etc.)
- **OpenSpec Specifications**: Formal specs in [`openspec/specs/`](./openspec/specs/)
- **Homelab Services**: Better-T-Stack monorepo docs in [`homelab-services/docs/`](./homelab-services/docs/)

## Repository Overview

Personal dotfiles and homelab infrastructure automation for macOS and Arch Linux environments. Two main components:

1. **Mac Setup** (`/mac`) - macOS dotfiles, Homebrew packages, system configuration
2. **Homelab Stack** (`/homelab`) - Docker-based self-hosted services for Arch Linux server

## Architecture Summary

### Homelab (Primary Component)

**Deployment**: CI/CD via self-hosted GitHub Actions runners on Arch Linux server

**Network**: Two isolated Docker networks
- `homelab` (172.20.0.0/16) - Core infrastructure (Home Assistant, DNS, AI, security)
- `media` (172.21.0.0/16) - Media services with VPN-protected downloads

**Management**: `homelab/homelab.sh` - Complete setup wizard and interactive menu

**State**: `.setup_state` file tracks wizard progress for resumable setup

### Mac Setup

**Entry Point**: `mac/install.sh` - Interactive installer for Homebrew, packages, dotfiles, and macOS defaults

## Essential Commands

### Homelab Management

```bash
# First-time setup (mandatory wizard)
cd homelab && ./homelab.sh

# Service management
./homelab.sh start [service]    # Start all or specific service
./homelab.sh stop                # Stop all services
./homelab.sh restart [service]   # Restart services
./homelab.sh status              # Show container status
./homelab.sh logs [service]      # View logs

# Maintenance
./homelab.sh update              # Pull latest Docker images
./homelab.sh backup              # Create configuration backup
./homelab.sh deploy              # Trigger GitHub Actions deployment

# Direct deployment (used by CI)
cd homelab/scripts
bash deploy-ci-streamlined.sh    # Streamlined deployment
```

### Mac Setup

```bash
cd mac && ./install.sh           # Run interactive installer
```

## Key Configuration Files

### Homelab

- `docker-compose.yml` - Main orchestrator with includes
- `compose/*.yml` - Service definitions (infrastructure, media, AI, monitoring, etc.)
- `.env` - Environment variables (auto-generated by wizard)
- `traefik/traefik.yml` - Static Traefik configuration
- `traefik/dynamic/*.yml` - Dynamic routes, middlewares, TLS

### Mac

- `homebrew/Brewfile` - Homebrew packages
- `zsh/.zshrc` - Zsh configuration
- `wezterm/wezterm.lua` - Terminal config
- `starship/starship.toml` - Prompt config

## Quick Troubleshooting

### Homelab Issues

**Service won't start:**
```bash
./homelab.sh logs <service>
docker compose ps <service>
```

**Permission errors:** Handled automatically by deployment scripts

**GitHub Runner issues:**
```bash
cd ~/actions-runner
sudo ./svc.sh status
sudo ./svc.sh restart
```

**DNS not resolving:**
```bash
# Check AdGuard status
docker compose ps adguardhome
docker compose logs adguardhome

# Test fallback
dig @1.1.1.1 google.com
```

### Mac Issues

**Build failures:**
```bash
cd mac && ./install.sh  # Re-run installer
```

## Documentation by Service

| Service | Documentation | OpenSpec Spec |
|---------|--------------|---------------|
| **DNS Configuration** | [docs/dns/](./docs/dns/) | [specs/dns-configuration](./openspec/specs/dns-configuration/) |
| **Home Assistant** | [docs/home-assistant/](./docs/home-assistant/) | [specs/home-assistant-integration](./openspec/specs/home-assistant-integration/) |
| **Coolify PaaS** | [docs/coolify/](./docs/coolify/) | [specs/coolify-paas](./openspec/specs/coolify-paas/) |
| **Deployment** | [docs/deployment/](./docs/deployment/) | [specs/deployment-orchestration](./openspec/specs/deployment-orchestration/) |
| **GitHub Actions** | [docs/github-actions/](./docs/github-actions/) | [specs/github-actions-workflows](./openspec/specs/github-actions-workflows/) |
| **Mac Setup** | [mac/README.md](./mac/README.md) | [specs/mac-development-environment](./openspec/specs/mac-development-environment/) |
| **Bluetooth** | CLAUDE.md (archived) | [specs/bluetooth-automation](./openspec/specs/bluetooth-automation/) |
| **Claude Agent** | [homelab-services/docs/](./homelab-services/docs/) | [specs/claude-agent-management](./openspec/specs/claude-agent-management/) |
| **Playwright Server** | [homelab-services/docs/](./homelab-services/docs/) | [specs/playwright-report-server](./openspec/specs/playwright-report-server/) |
| **Error Automation** | CLAUDE.md (see below) | N/A |
| **Multi-Runner** | CLAUDE.md (archived) | [specs/multi-runner-orchestration](./openspec/specs/multi-runner-orchestration/) |
| **Steam Gaming** | CLAUDE.md (archived) | [specs/steam-gaming-setup](./openspec/specs/steam-gaming-setup/) |
| **USB Boot** | CLAUDE.md (archived) | [specs/usb-boot-automation](./openspec/specs/usb-boot-automation/) |

## Homelab Services (Better-T-Stack Monorepo)

The `homelab-services/` directory contains a Better-T-Stack monorepo with type-safe applications:

**Applications:**
- **Claude Agent** (port 3002) - Claude Code session management
- **Playwright Server** (port 3000) - Test report aggregation

**Documentation:**
- [Architecture Guide](./homelab-services/docs/architecture.md) - Better-T-Stack design
- [Development Guide](./homelab-services/docs/development.md) - Setup and workflows
- [Contributing Guide](./homelab-services/docs/contributing.md) - Code standards
- [Deployment Guide](./homelab-services/docs/deployment.md) - Docker builds and CI/CD
- [Documentation Index](./homelab-services/docs/INDEX.md) - Complete navigation

## Error-to-Spec Auto-Generation

The `homelab-services` monorepo includes an automated error detection and proposal generation system that converts Playwright test failures into actionable OpenSpec change proposals.

### How It Works

1. **Failure Detection**: FailureWatcher service polls for new test failures every 30 seconds
2. **Error Analysis**: Failures are classified by type (type-error, missing-property, assertion-failure, network-error, configuration-error)
3. **Proposal Generation**: Complete OpenSpec proposals are auto-generated with:
   - Title: `Fix: <test-name>`
   - Why section: Error details, classification, occurrence count
   - What Changes: Suggested fixes based on error type
   - Tasks: Step-by-step implementation checklist
4. **Priority Assignment**: Errors receive priority 1-5 based on classification and occurrence count
5. **Work Queue Integration**: Approved proposals automatically enter the work queue

### Priority Escalation

Errors automatically escalate in priority as they recur:

| Classification | Initial Priority | Escalation Trigger | Escalated Priority |
|---------------|------------------|--------------------|--------------------|
| **NEW** | 2 | 2+ occurrences | 3 (FLAKY level) |
| **FLAKY** | 3 | 3+ occurrences | 4 (RECURRING level) |
| **RECURRING** | 4 | 4+ occurrences | 5 (PERSISTENT level) |
| **PERSISTENT** | 5 | Always max | 5 |

### Error Proposals Dashboard

Access the dashboard at `http://localhost:3002/errors`

**Features:**
- **Filter Sidebar**: Search, classification filters, priority range slider
- **Real-Time Updates**: Automatic updates via tRPC subscriptions
- **Approve/Reject**: Review and approve proposals with one click
- **View Related**: See all historical failures for the same test
- **Statistics**: Track total proposals by classification and priority

**Workflow:**
1. Test fails â†’ Proposal auto-generated
2. Review proposal in dashboard
3. **Approve** â†’ Moves to work queue with assigned priority
4. **Reject** â†’ Archives proposal with rejection reason

### API Endpoints

Error proposals are managed via tRPC router at `packages/api/src/router/error-proposals.ts`:

**Queries:**
- `listPending` - Get pending error proposals (supports filtering, sorting, pagination)
- `get` - Get detailed proposal by ID
- `stats` - Get statistics by classification and priority
- `getRelatedFailures` - Get all failures for the same test

**Mutations:**
- `link` - Link proposal to existing spec
- `regenerate` - Regenerate proposal content

**Subscriptions:**
- `subscribe` - Real-time events: proposal_generated, proposal_updated, priority_escalated

### Database Schema

Error proposals are stored in the `error_proposals` table:

```typescript
{
  id: number
  testFailureId: number (FK to test_failures)
  specId: string (FK to openspec_specs)
  generatedAt: timestamp
  lastFailureAt: timestamp
  autoGeneratedContent: JSON (proposal content)
  userModified: boolean
  occurrenceCount: number
}
```

### Testing

**Unit Tests** (33 tests): `packages/api/src/utils/__tests__/error-analysis.test.ts`
- Error classification
- Message extraction
- Priority calculation
- File path extraction

**Integration Tests** (11 tests): `packages/api/src/services/__tests__/failure-watcher.integration.test.ts`
- Priority escalation flow
- Duplicate detection
- Work queue integration
- Full workflow simulation

**E2E Tests** (20+ scenarios): `apps/claude-agent-web/e2e/error-proposals.spec.ts`
- Dashboard rendering
- Filtering and searching
- Approve/reject workflows
- Real-time updates

### Key Files

| File | Purpose |
|------|---------|
| `packages/api/src/utils/error-analysis.ts` | Error classification and analysis utilities |
| `packages/api/src/services/error-proposal-generator.ts` | Proposal generation service |
| `packages/api/src/services/failure-watcher.ts` | Failure detection and polling |
| `packages/api/src/router/error-proposals.ts` | tRPC API router |
| `packages/db/src/schema/error-proposals.ts` | Database schema |
| `apps/claude-agent-web/src/app/(dashboard)/errors/page.tsx` | Dashboard UI |
| `apps/claude-agent-web/instrumentation.ts` | Server startup hook for watcher |

### Configuration

The FailureWatcher is initialized in `instrumentation.ts` and runs automatically when the Next.js server starts:

```typescript
{
  projectId: 1,
  projectPath: '/path/to/project',
  openspecPath: '/path/to/openspec',
  pollingInterval: 30000 // 30 seconds
}
```

### Notes for Claude Code

- Error proposals are **read-only** until approved/rejected by a user
- Duplicate detection uses test name + error message comparison
- Priority escalation updates both the proposal and work queue
- Real-time subscriptions use EventEmitter with tRPC observables
- Proposals create complete OpenSpec file structure (proposal.md, tasks.md)

## Getting Help

1. **Check documentation**: [Documentation Index](./docs/INDEX.md)
2. **Review OpenSpec specs**: [openspec/specs/](./openspec/specs/)
3. **Read archived details**: [openspec/changes/archive/](./openspec/changes/archive/)
4. **Search issues**: Check GitHub Issues for similar problems

## Notes for Claude Code

- **OpenSpec Changes**: Use `/openspec:proposal` for new capabilities, `/openspec:apply` to implement
- **Documentation**: Always check service-specific docs in `docs/` before making changes
- **Testing**: Use `openspec validate --strict` to validate specifications
- **State Management**: Respect `.setup_state` in homelab wizard for resumable operations
- **Archived Content**: Original detailed documentation preserved in `openspec/changes/archive/`
