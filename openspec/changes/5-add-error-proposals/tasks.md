# Implementation Tasks: Error-to-Spec Auto-Generation

## Phase 5.1: Error Proposal Database Schema

### 5.1.1 Error Proposals Table
- [ ] Create `errorProposals` table in `packages/db/src/schema/error-proposals.ts`
  - [ ] Add id (primary key), testFailureId (foreign key to testFailures)
  - [ ] Add specId (nullable foreign key to openspecSpecs)
  - [ ] Add generatedAt, lastFailureAt timestamps
  - [ ] Add autoGeneratedContent (JSON text - stored original proposal data)
  - [ ] Add userModified (boolean - default false)
  - [ ] Add occurrenceCount (integer - track recurrences)
  - [ ] Add indexes: (testFailureId), (specId), (generatedAt)

### 5.1.2 Schema Export and Migration
- [ ] Export errorProposals schema from `packages/db/src/schema/index.ts`
- [ ] Run migrations

## Phase 5.2: Zod Validators

### 5.2.1 Error Proposal Validators
- [ ] Create `packages/validators/src/error-proposals.ts`
  - [ ] `errorProposalSchema` - Full error proposal record
  - [ ] `proposalGenerationSchema` - Generation request
  - [ ] `proposalLinkSchema` - Link to existing spec

## Phase 5.3: Error Analysis and Proposal Generation

### 5.3.1 Create Error Analysis Utilities
- [ ] Create `packages/api/src/utils/error-analysis.ts`
  - [ ] `extractTestName(stackTrace)` - Clean test name from trace
  - [ ] `extractErrorMessage(error)` - Get primary error message
  - [ ] `extractStackTrace(error)` - Relevant stack trace lines
  - [ ] `classifyErrorType(errorMessage)` - Detect error category:
    - [ ] Type error: "is not assignable to type"
    - [ ] Missing property: "Property X does not exist"
    - [ ] Assertion failure: "Expected X but got Y"
    - [ ] Network error: "timeout", "connection refused"
    - [ ] Configuration: "config", "not found", "missing"
    - [ ] Other: default
  - [ ] `inferFixFromErrorType(errorType)` - Suggest fix approach

### 5.3.2 Create ErrorProposalGenerator
- [ ] Create `packages/api/src/services/error-proposal-generator.ts`
  - [ ] `generateProposal(testFailure, projectPath, changeNumber)` - Main method
  - [ ] `generateTitle(testName)` - Clean test name to "Fix: {title}"
  - [ ] `generateWhySection(testFailure)` - Build why section with error details
  - [ ] `generateWhatChanges(testFailure, errorType)` - Suggest changes based on error
  - [ ] `generateTasks(testFailure, errorType, affectedFiles)` - Auto-generate tasks.md
  - [ ] `calculatePriority(testFailure)` - PERSISTENT=5, RECURRING=4, FLAKY=3, NEW=2

### 5.3.3 Proposal Generation Details
- [ ] Why Section should include:
  - [ ] Classification (PERSISTENT/RECURRING/FLAKY/NEW)
  - [ ] Error message (full, in code block)
  - [ ] Stack trace (relevant lines, in code block)
  - [ ] Failure pattern (N occurrences, first seen X, last seen Y)
- [ ] What Changes section:
  - [ ] Type mismatch → "Update type definitions to match usage"
  - [ ] Missing property → "Add {propertyName} field"
  - [ ] Assertion failed → "Implement missing functionality for {feature}"
  - [ ] Network error → "Add retry logic and timeout handling"
  - [ ] Configuration → "Update configuration file {path}"
- [ ] Tasks generation:
  - [ ] "Investigate {fileName} - understand the error"
  - [ ] "Implement fix for {issue}"
  - [ ] "Add test coverage"
  - [ ] "Run tests and verify"
  - [ ] Format with checkboxes: `- [ ] 1. Task name`

### 5.3.4 Create Proposal Files
- [ ] `createProposalFiles(generator, projectPath, changeNumber)` method
  - [ ] Create change directory: `changes/{changeNumber}-fix-{errorName}/`
  - [ ] Write proposal.md with generated content
  - [ ] Write tasks.md with generated tasks
  - [ ] Create specs/ directory for spec deltas
  - [ ] Return path to created proposal
  - [ ] Call OpenSpecSyncService to sync to DB

## Phase 5.4: Failure Watcher Service

### 5.4.1 Create FailureWatcherService
- [ ] Create `packages/api/src/services/failure-watcher.ts`
  - [ ] `startWatcher(projectId, projectPath)` - Start monitoring for project
  - [ ] `processPendingFailures(projectId)` - Scan for new failures
  - [ ] `handleNewFailure(testFailure, projectId)` - Process single failure
  - [ ] `stopWatcher()` - Gracefully stop

### 5.4.2 Polling Logic
- [ ] `processPendingFailures` should:
  - [ ] Query testFailures table for failures without errorProposals entry
  - [ ] For each: Call `handleNewFailure`
  - [ ] Handle errors gracefully (continue on failure)
  - [ ] Log processing summary

### 5.4.3 Duplicate Detection
- [ ] `handleNewFailure` should:
  - [ ] Extract testName from failure
  - [ ] Query: Check if errorProposal exists for same testName
  - [ ] If not exists: Generate new proposal
  - [ ] If exists: Compare error message
    - [ ] If similar (same error): Update lastFailureAt, increment occurrenceCount
    - [ ] If different (new error): Generate new proposal
  - [ ] Create or update errorProposals table entry
  - [ ] Emit event: error_proposal_generated or error_proposal_updated

### 5.4.4 Scheduler Integration
- [ ] In `packages/api/src/server.ts` or startup script
  - [ ] Start failure watcher on server initialization
  - [ ] Schedule periodic processing (every 30 seconds)
  - [ ] Use node-cron if needed
  - [ ] Handle graceful shutdown

## Phase 5.5: Priority Escalation Logic

### 5.5.1 Implement Priority Escalation
- [ ] `calculatePriority(testFailure, occurrenceCount)` method
  - [ ] Base priority from classification:
    - [ ] PERSISTENT → 5
    - [ ] RECURRING → 4
    - [ ] FLAKY → 3
    - [ ] NEW → 2
- [ ] `escalatePriority(errorProposalId, newOccurrenceCount)` method
  - [ ] NEW (1 occurrence) → stays 2
  - [ ] FLAKY (2 occurrences) → escalate to 3
  - [ ] RECURRING (3 occurrences) → escalate to 4
  - [ ] PERSISTENT (4+ occurrences) → escalate to 5
  - [ ] If already PERSISTENT → stays 5
  - [ ] Update work queue item priority if spec already queued

### 5.5.2 Priority Update Logic
- [ ] When recurrence detected:
  - [ ] Increment occurrenceCount
  - [ ] Calculate new priority
  - [ ] Update errorProposals.priority (if column added)
  - [ ] Query: Find work queue item for this spec
  - [ ] If found: Update work queue item priority
  - [ ] Emit event: error_priority_escalated

## Phase 5.6: Work Queue Integration

### 5.6.1 Auto-Queue Generated Proposals
- [ ] When error proposal generated:
  - [ ] Create spec (write files to filesystem)
  - [ ] Sync to DB (spec status='proposing')
  - [ ] Call WorkQueueService.addToQueue(projectId, specId, calculatedPriority)
  - [ ] Update errorProposals.specId with new spec ID
  - [ ] Emit: error_queued event

## Phase 5.7: Zod Validators

### 5.7.1 Error Proposal Validators
- [ ] Create validators in `packages/validators/src/error-proposals.ts`
  - [ ] `errorProposalSchema` - Full record
  - [ ] `proposalGenerationSchema` - Generation request

## Phase 5.8: Error Proposals tRPC Router

### 5.8.1 Create Router
- [ ] Create `packages/api/src/router/error-proposals.ts`
  - [ ] Import ErrorProposalService, FailureWatcherService, validators

### 5.8.2 Query Procedures
- [ ] `errorProposals.listPending` procedure
  - [ ] Input: `{ projectId?: number, filter?: { classification?, priority?, sortBy? } }`
  - [ ] Return: Array of error proposals with status='proposing'
  - [ ] Sorted by occurrenceCount DESC, priority DESC
- [ ] `errorProposals.get` procedure
  - [ ] Input: `{ errorProposalId: string }`
  - [ ] Return: Full error proposal with linked testFailure details
- [ ] `errorProposals.stats` procedure
  - [ ] Input: `{ projectId?: number }`
  - [ ] Return: { totalProposals, byClassification: {}, byPriority: {} }

### 5.8.3 Mutation Procedures
- [ ] `errorProposals.link` procedure
  - [ ] Input: `{ errorProposalId: string, existingSpecId: string }`
  - [ ] Link error to existing spec instead of creating new
  - [ ] Return: Updated errorProposal
- [ ] `errorProposals.regenerate` procedure
  - [ ] Input: `{ errorProposalId: string }`
  - [ ] Regenerate proposal with latest error info
  - [ ] Return: Regenerated proposal

### 5.8.4 Subscription Procedure
- [ ] `errorProposals.subscribe` procedure
  - [ ] Input: `{ projectId?: number }`
  - [ ] Stream events: proposal_generated, proposal_updated, priority_escalated
  - [ ] Include: errorProposalId, testFailureId, specId, priority, classification

### 5.8.5 Integration with Root Router
- [ ] Import errorProposalsRouter in `packages/api/src/root.ts`
- [ ] Export as part of appRouter

## Phase 5.9: Dashboard Errors Tab

### 5.9.1 Create Errors Page Component
- [ ] Create `apps/claude-agent-web/src/app/dashboard/errors/page.tsx`
  - [ ] OR add Errors filter to existing /dashboard/work-queue if combining tabs
  - [ ] Layout: Filter sidebar + error proposals table
  - [ ] Use tRPC query: errorProposals.listPending

### 5.9.2 Filter Sidebar
- [ ] Classifications checkboxes: PERSISTENT, RECURRING, FLAKY, NEW
- [ ] Priority range slider (1-5)
- [ ] Sort options: By occurrences, By priority, By date
- [ ] Search: Filter by test name

### 5.9.3 Error Proposals Table
- [ ] Columns:
  - [ ] Type badge: "Error" (red)
  - [ ] Test name (linked to test failure details)
  - [ ] Error type (badge: "Type Error", "Missing Field", etc.)
  - [ ] Priority (stars)
  - [ ] Classification (badge: PERSISTENT/RECURRING/FLAKY/NEW)
  - [ ] Occurrences (count)
  - [ ] First seen, Last seen (dates)
  - [ ] Actions: Approve, Reject, View Related
- [ ] Sortable: By priority, occurrences, date
- [ ] Row styling: Color-coded by priority (red=5, orange=4, yellow=3, blue=2)

### 5.9.4 Row Actions
- [ ] "Approve" button
  - [ ] Moves error proposal to work queue
  - [ ] Calls lifecycle.approve({ specId })
  - [ ] Returns to work queue tab
- [ ] "Reject" button
  - [ ] Shows rejection reason modal
  - [ ] Archives spec immediately
  - [ ] Removes from work queue
- [ ] "View Related" button
  - [ ] Shows list of all test failures linked to this error
  - [ ] Links to Playwright server test details

### 5.9.5 Real-Time Updates
- [ ] Use subscription: `errorProposals.subscribe({ projectId })`
- [ ] On proposal_generated: Add row to table with animation
- [ ] On proposal_updated (new occurrence): Update row with new occurrenceCount and priority
- [ ] On priority_escalated: Highlight row briefly to show priority increase
- [ ] Show toast: "New error found! Fix: {testName} (Priority {N})"

## Phase 5.10: Testing

### 5.10.1 Unit Tests
- [ ] Test error analysis utilities
  - [ ] Extract test names correctly
  - [ ] Classify error types correctly
  - [ ] Generate appropriate fix suggestions
- [ ] Test proposal generation
  - [ ] Generate title, why section, what changes, tasks
  - [ ] All sections have required content
  - [ ] Priority calculated correctly
- [ ] Test duplicate detection
  - [ ] Same test name with same error → update existing
  - [ ] Same test name with different error → create new
  - [ ] Priority escalation on recurrence

### 5.10.2 Integration Tests
- [ ] Simulate test failure
  - [ ] FailureWatcher detects it
  - [ ] Proposal generated
  - [ ] Spec created and synced to DB
  - [ ] Work queue item created
- [ ] Test duplicate and escalation
  - [ ] Error occurs 3x with same message
  - [ ] Verify priority escalates: 2→3→4→5
  - [ ] Work queue item priority updated

### 5.10.3 E2E Tests
- [ ] Dashboard shows new error proposal
  - [ ] Real-time update on error generation
  - [ ] User can approve proposal
  - [ ] Proposal moves to work queue
  - [ ] User can reject proposal
  - [ ] Proposal archived

## Phase 5.11: Documentation

### 5.11.1 Update CLAUDE.md
- [ ] Add section on error automation
- [ ] Document error proposal generation
- [ ] Document error priority escalation

### 5.11.2 Inline Documentation
- [ ] JSDoc on error analysis functions
- [ ] Comments on proposal generation logic

## Summary

**Subtasks**: ~50
**Estimated Timeline**: 1 week
**Dependencies**: Change 1, 2, 3 complete (Change 4 optional but helpful)

**Critical Path**:
1. Error analysis utilities (5.3)
2. Proposal generator (5.3)
3. Failure watcher (5.4)
4. Work queue integration (5.6)
5. Error router (5.8)
6. Dashboard (5.9)
7. Testing (5.10)
