# Change: Add Error-to-Spec Auto-Generation

## Why

Changes 1-4 established a complete workflow for managing approved specs through implementation via workers, but this workflow is reactive: specs are manually created or error proposals exist separately. This creates a gap: Playwright test failures aren't automatically converted to actionable spec proposals for the work queue.

By adding automatic error proposal generation, the Claude agent service becomes capable of:
- **Automatic Proposal Generation**: All Playwright test failures automatically generate spec proposals in 'proposing' state
- **Error Classification Integration**: Use existing failure classification (PERSISTENT, RECURRING, FLAKY, NEW) to set proposal priority
- **Smart Duplicate Detection**: Link multiple failures to same proposal if root cause matches
- **Async Auto-Queuing**: Generated proposals automatically added to work queue
- **Priority Escalation**: If same error recurs, increase priority automatically

This change focuses on **turning every test failure into a spec proposal** without user intervention. The proposal must be reviewed before implementation, but the proposal generation is fully automated.

## What Changes

### Error Proposal Tracking

- **New Table**: `errorProposals` links test failures to generated specs
  - Fields: id, testFailureId (FK to testFailures), specId (FK to openspecSpecs, nullable until created)
  - generatedAt timestamp, lastFailureAt (updated each time error recurs)
  - autoGeneratedContent (JSON - original generated proposal data)
  - userModified boolean (did user edit before approval?)
  - occurrenceCount (how many times has this error occurred)
- **Foreign Keys**: testFailureId → testFailures (Playwright), specId → openspecSpecs (or null if spec not yet created)

### Error Proposal Service

- **ErrorProposalService**: Generates spec proposals from test failures
  - `generateProposal(testFailure)` - Create complete proposal.md + tasks.md + design.md (optional)
  - `inferChangesFromError(testFailure)` - Analyze error to suggest fixes
  - `calculatePriority(classification)` - Map PERSISTENT→5, RECURRING→4, FLAKY→3, NEW→2
  - `createProposalFiles(proposal, projectPath, changeId)` - Write to filesystem
  - `linkToExistingProposal(testFailure, existingSpecId)` - Link to existing spec instead of creating new

### Proposal Auto-Generation Algorithm

- **Title**: "Fix: {testName}" (clean test name from stack trace)
- **Why Section**:
  - Include classification (PERSISTENT/RECURRING/FLAKY/NEW)
  - Include error message (full)
  - Include stack trace (relevant parts)
  - Include failure pattern: "Occurs in {N}% of runs, first seen {date}, last seen {date}"
- **What Changes**: Infer from error type
  - Type mismatch → "Update type definition"
  - Missing property → "Add missing field"
  - Assertion failed → "Implement missing feature"
  - Network timeout → "Add retry logic or timeout handling"
  - Configuration error → "Update configuration"
- **Tasks**: Auto-generate from stack trace
  - Identify affected files
  - Generate tasks: "Investigate {fileName}", "Fix {issue}", "Add test coverage", "Run tests"
  - Format as tasks.md with checkboxes

### Failure Watcher Integration

- **Failure Watcher Service**: Subscribes to new testFailures
  - Poll testFailures table or use Drizzle trigger (every 30s)
  - For each new failure: Check if proposal already exists
  - If not: Call ErrorProposalService.generateProposal()
  - Record in errorProposals table
  - Add generated spec to work queue with calculated priority
- **Duplicate Detection**:
  - Check if proposal exists for same testName
  - If exists: Compare error message
  - If different: Create new proposal (different error)
  - If same: Update existingProposal.lastFailureAt, increment occurrenceCount

### Priority Escalation

- **Initial Priority**: Based on classification (PERSISTENT=5, etc.)
- **Recurrence Tracking**: If same error occurs again
  - If NEW, 1st recurrence → FLAKY (priority 3)
  - If FLAKY, 2nd recurrence → RECURRING (priority 4)
  - If RECURRING, 3rd+ recurrence → PERSISTENT (priority 5)
  - If PERSISTENT, still 5 (already max)
- **Auto-Requeue**: Update work queue item priority if spec already queued

### tRPC Router

- **New Router**: `packages/api/src/router/error-proposals.ts`
  - `errorProposals.listPending({ projectId? })` - Proposals awaiting approval
  - `errorProposals.get({ errorProposalId })` - Detailed error proposal
  - `errorProposals.regenerate({ errorProposalId })` - Regenerate with updated error info
  - `errorProposals.link({ errorProposalId, existingSpecId })` - Link to existing spec
  - `errorProposals.subscribe({ projectId? })` - Stream new error proposals

### Dashboard Errors Tab

- **New UI Tab**: `/dashboard/errors` (or combined in `/dashboard/work-queue` with type filter)
  - Table of error proposals: Type badge, Test name, Error type (badge), Priority, Classification, Occurrences, Actions
  - Filter: Project, Classification (PERSISTENT/RECURRING/FLAKY/NEW), Priority
  - Sort: By occurrences (most frequent first), then by priority
  - Row actions: View, Approve (move to queue), Reject (archive), View Related Failures (link to test failures)
  - Real-time updates: New errors appear with animation

## Impact

### Affected Specs
- **error-automation**: ADDED - Spec for automatic error proposal generation
- **failure-watcher**: ADDED - Spec for monitoring new test failures
- **spec-lifecycle-management**: MODIFIED - Handle auto-generated specs in 'proposing' state
- **work-queue-management**: MODIFIED - Auto-add generated proposals to queue

### Affected Code
- `homelab-services/packages/db/src/schema/error-proposals.ts` - NEW table schema
- `homelab-services/packages/api/src/services/error-proposal.ts` - NEW service class
- `homelab-services/packages/api/src/services/failure-watcher.ts` - NEW watcher service
- `homelab-services/packages/validators/src/error-proposals.ts` - NEW validators
- `homelab-services/packages/api/src/router/error-proposals.ts` - NEW tRPC router
- `homelab-services/apps/claude-agent-web/src/app/dashboard/errors/page.tsx` - NEW UI page (or filter in work-queue)
- `homelab-services/packages/api/src/services/error-proposal-generator.ts` - Error analysis logic

### Dependencies
- **Existing**: Drizzle ORM, tRPC, Zod, Playwright server (testFailures table)
- **New**: None (uses existing send_event hook infrastructure)
- **Prerequisite**: Change 1 (Sync), Change 2 (Lifecycle), Change 3 (Work Queue) should be complete

### Breaking Changes
None. Purely additive. No impact on existing error handling or sessions.

## Acceptance Criteria

- [ ] Error proposals table created with schema
- [ ] Error proposal service generates proposal with title, why, what changes, tasks
- [ ] Priority calculation works: PERSISTENT=5, RECURRING=4, FLAKY=3, NEW=2
- [ ] Duplicate detection correctly links related errors
- [ ] Priority escalation increases priority on recurrence
- [ ] Failure watcher detects new failures and generates proposals
- [ ] Generated specs automatically added to work queue
- [ ] Dashboard errors tab displays proposals with filters and sorting
- [ ] Real-time subscription streams new error proposals
- [ ] Tests pass (unit for service, integration for watcher and generation)
