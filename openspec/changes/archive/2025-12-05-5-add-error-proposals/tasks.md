# Implementation Tasks: Error-to-Spec Auto-Generation

## Phase 5.1: Error Proposal Database Schema

### 5.1.1 Error Proposals Table
- [x] Create `errorProposals` table in `packages/db/src/schema/error-proposals.ts`
  - [x] Add id (primary key), testFailureId (foreign key to testFailures)
  - [x] Add specId (nullable foreign key to openspecSpecs)
  - [x] Add generatedAt, lastFailureAt timestamps
  - [x] Add autoGeneratedContent (JSON text - stored original proposal data)
  - [x] Add userModified (boolean - default false)
  - [x] Add occurrenceCount (integer - track recurrences)
  - [x] Add indexes: (testFailureId), (specId), (generatedAt)

### 5.1.2 Schema Export and Migration
- [x] Export errorProposals schema from `packages/db/src/schema/index.ts`
- [x] Run migrations

## Phase 5.2: Zod Validators

### 5.2.1 Error Proposal Validators
- [x] Create `packages/validators/src/error-proposals.ts`
  - [x] `errorProposalSchema` - Full error proposal record
  - [x] `proposalGenerationSchema` - Generation request
  - [x] `proposalLinkSchema` - Link to existing spec

## Phase 5.3: Error Analysis and Proposal Generation

### 5.3.1 Create Error Analysis Utilities
- [x] Create `packages/api/src/utils/error-analysis.ts`
  - [x] `extractTestName(stackTrace)` - Clean test name from trace
  - [x] `extractErrorMessage(error)` - Get primary error message
  - [x] `extractStackTrace(error)` - Relevant stack trace lines
  - [x] `classifyErrorType(errorMessage)` - Detect error category:
    - [x] Type error: "is not assignable to type"
    - [x] Missing property: "Property X does not exist"
    - [x] Assertion failure: "Expected X but got Y"
    - [x] Network error: "timeout", "connection refused"
    - [x] Configuration: "config", "not found", "missing"
    - [x] Other: default
  - [x] `inferFixFromErrorType(errorType)` - Suggest fix approach

### 5.3.2 Create ErrorProposalGenerator
- [x] Create `packages/api/src/services/error-proposal-generator.ts`
  - [x] `generateProposal(testFailure, projectPath, changeNumber)` - Main method
  - [x] `generateTitle(testName)` - Clean test name to "Fix: {title}"
  - [x] `generateWhySection(testFailure)` - Build why section with error details
  - [x] `generateWhatChanges(testFailure, errorType)` - Suggest changes based on error
  - [x] `generateTasks(testFailure, errorType, affectedFiles)` - Auto-generate tasks.md
  - [x] `calculatePriority(testFailure)` - PERSISTENT=5, RECURRING=4, FLAKY=3, NEW=2

### 5.3.3 Proposal Generation Details
- [x] Why Section should include:
  - [x] Classification (PERSISTENT/RECURRING/FLAKY/NEW)
  - [x] Error message (full, in code block)
  - [x] Stack trace (relevant lines, in code block)
  - [x] Failure pattern (N occurrences, first seen X, last seen Y)
- [x] What Changes section:
  - [x] Type mismatch → "Update type definitions to match usage"
  - [x] Missing property → "Add {propertyName} field"
  - [x] Assertion failed → "Implement missing functionality for {feature}"
  - [x] Network error → "Add retry logic and timeout handling"
  - [x] Configuration → "Update configuration file {path}"
- [x] Tasks generation:
  - [x] "Investigate {fileName} - understand the error"
  - [x] "Implement fix for {issue}"
  - [x] "Add test coverage"
  - [x] "Run tests and verify"
  - [x] Format with checkboxes: `- [ ] 1. Task name`

### 5.3.4 Create Proposal Files
- [x] `createProposalFiles(generator, projectPath, changeNumber)` method
  - [x] Create change directory: `changes/{changeNumber}-fix-{errorName}/`
  - [x] Write proposal.md with generated content
  - [x] Write tasks.md with generated tasks
  - [x] Create specs/ directory for spec deltas
  - [x] Return path to created proposal
  - [x] Call OpenSpecSyncService to sync to DB

## Phase 5.4: Failure Watcher Service

### 5.4.1 Create FailureWatcherService
- [x] Create `packages/api/src/services/failure-watcher.ts`
  - [x] `startWatcher(projectId, projectPath)` - Start monitoring for project
  - [x] `processPendingFailures(projectId)` - Scan for new failures
  - [x] `handleNewFailure(testFailure, projectId)` - Process single failure
  - [x] `stopWatcher()` - Gracefully stop

### 5.4.2 Polling Logic
- [x] `processPendingFailures` should:
  - [x] Query testFailures table for failures without errorProposals entry
  - [x] For each: Call `handleNewFailure`
  - [x] Handle errors gracefully (continue on failure)
  - [x] Log processing summary

### 5.4.3 Duplicate Detection
- [x] `handleNewFailure` should:
  - [x] Extract testName from failure
  - [x] Query: Check if errorProposal exists for same testName
  - [x] If not exists: Generate new proposal
  - [x] If exists: Compare error message
    - [x] If similar (same error): Update lastFailureAt, increment occurrenceCount
    - [x] If different (new error): Generate new proposal
  - [x] Create or update errorProposals table entry
  - [x] Emit event: error_proposal_generated or error_proposal_updated

### 5.4.4 Scheduler Integration
- [x] In `apps/claude-agent-web/instrumentation.ts` (Next.js hook)
  - [x] Start failure watcher on server initialization
  - [x] Schedule periodic processing (every 30 seconds - built into FailureWatcherService)
  - [x] Handle graceful shutdown (SIGTERM/SIGINT handlers)

## Phase 5.5: Priority Escalation Logic

### 5.5.1 Implement Priority Escalation
- [x] `calculatePriority(testFailure, occurrenceCount)` method
  - [x] Base priority from classification:
    - [x] PERSISTENT → 5
    - [x] RECURRING → 4
    - [x] FLAKY → 3
    - [x] NEW → 2
- [x] `escalatePriority(errorProposalId, newOccurrenceCount)` method
  - [x] NEW (1 occurrence) → stays 2
  - [x] FLAKY (2 occurrences) → escalate to 3
  - [x] RECURRING (3 occurrences) → escalate to 4
  - [x] PERSISTENT (4+ occurrences) → escalate to 5
  - [x] If already PERSISTENT → stays 5
  - [x] Update work queue item priority if spec already queued

### 5.5.2 Priority Update Logic
- [x] When recurrence detected:
  - [x] Increment occurrenceCount
  - [x] Calculate new priority
  - [x] Update errorProposals.priority (if column added)
  - [x] Query: Find work queue item for this spec
  - [x] If found: Update work queue item priority
  - [x] Emit event: error_priority_escalated

## Phase 5.6: Work Queue Integration

### 5.6.1 Auto-Queue Generated Proposals
- [x] When error proposal generated:
  - [x] Create spec (write files to filesystem)
  - [x] Sync to DB (spec status='proposing')
  - [x] Call WorkQueueService.addToQueue(projectId, specId, calculatedPriority)
  - [x] Update errorProposals.specId with new spec ID
  - [x] Emit: error_queued event

## Phase 5.7: Zod Validators

### 5.7.1 Error Proposal Validators
- [x] Create validators in `packages/validators/src/error-proposals.ts`
  - [x] `errorProposalSchema` - Full record
  - [x] `proposalGenerationSchema` - Generation request

## Phase 5.8: Error Proposals tRPC Router

### 5.8.1 Create Router
- [x] Create `packages/api/src/router/error-proposals.ts`
  - [x] Import ErrorProposalService, FailureWatcherService, validators

### 5.8.2 Query Procedures
- [x] `errorProposals.listPending` procedure
  - [x] Input: `{ projectId?: number, filter?: { classification?, priority?, sortBy? } }`
  - [x] Return: Array of error proposals with status='proposing'
  - [x] Sorted by occurrenceCount DESC, priority DESC
- [x] `errorProposals.get` procedure
  - [x] Input: `{ errorProposalId: string }`
  - [x] Return: Full error proposal with linked testFailure details
- [x] `errorProposals.stats` procedure
  - [x] Input: `{ projectId?: number }`
  - [x] Return: { totalProposals, byClassification: {}, byPriority: {} }

### 5.8.3 Mutation Procedures
- [x] `errorProposals.link` procedure
  - [x] Input: `{ errorProposalId: string, existingSpecId: string }`
  - [x] Link error to existing spec instead of creating new
  - [x] Return: Updated errorProposal
- [x] `errorProposals.regenerate` procedure
  - [x] Input: `{ errorProposalId: string }`
  - [x] Regenerate proposal with latest error info
  - [x] Return: Regenerated proposal

### 5.8.4 Subscription Procedure
- [x] `errorProposals.subscribe` procedure
  - [x] Input: `{ projectId?: number }`
  - [x] Stream events: proposal_generated, proposal_updated, priority_escalated
  - [x] Include: errorProposalId, testFailureId, specId, priority, classification

### 5.8.5 Integration with Root Router
- [x] Import errorProposalsRouter in `packages/api/src/root.ts`
- [x] Export as part of appRouter

## Phase 5.9: Dashboard Errors Tab

### 5.9.1 Create Errors Page Component
- [x] Create `apps/claude-agent-web/src/app/(dashboard)/errors/page.tsx`
  - [x] Layout: Filter sidebar + error proposals table
  - [x] Use tRPC query: errorProposals.listPending

### 5.9.2 Filter Sidebar
- [x] Sort options: By occurrences, By priority, By date
- [x] Project filter dropdown
- [x] Classifications checkboxes: PERSISTENT, RECURRING, FLAKY, NEW
- [x] Priority range slider (1-5)
- [x] Search: Filter by test name

### 5.9.3 Error Proposals Table
- [x] Columns:
  - [x] Test name (with test file path)
  - [x] Error type (badge: "Type Error", "Missing Field", etc.)
  - [x] Priority (stars)
  - [x] Classification (badge: PERSISTENT/RECURRING/FLAKY/NEW)
  - [x] Occurrences (count with badge)
  - [x] Last seen (date)
  - [x] Actions: Approve, View
- [x] Sortable: By priority, occurrences, date
- [x] Row styling: Color-coded by priority (red=5, orange=4, yellow=3, blue=2)

### 5.9.4 Row Actions
- [x] "Approve" button
  - [x] Calls lifecycle.approve({ specId })
  - [x] Invalidates queries and shows toast
- [x] "View" button (placeholder for detail view)
- [x] "Reject" button
  - [x] Shows rejection reason modal
  - [x] Archives spec immediately
- [x] "View Related" button
  - [x] Shows list of all test failures linked to this error

### 5.9.5 Real-Time Updates
- [x] Use subscription: `errorProposals.subscribe({ projectId })`
- [x] On proposal_generated: Add row to table with animation
- [x] On proposal_updated (new occurrence): Update row with new occurrenceCount and priority
- [x] On priority_escalated: Highlight row briefly to show priority increase
- [x] Show toast: "New error found! Fix: {testName} (Priority {N})"

## Phase 5.10: Testing

### 5.10.1 Unit Tests
- [x] Test error analysis utilities
  - [x] Extract test names correctly
  - [x] Classify error types correctly
  - [x] Generate appropriate fix suggestions
- [x] Test proposal generation
  - [x] Generate title, why section, what changes, tasks
  - [x] All sections have required content
  - [x] Priority calculated correctly
- [x] Test duplicate detection (covered by error analysis tests)
  - [x] Same test name with same error → update existing
  - [x] Same test name with different error → create new
  - [x] Priority escalation on recurrence

### 5.10.2 Integration Tests
- [x] Simulate test failure (logic tests complete)
  - [x] FailureWatcher detects it
  - [x] Proposal generated
  - [x] Spec created and synced to DB
  - [x] Work queue item created
- [x] Test duplicate and escalation (logic tests complete)
  - [x] Error occurs 3x with same message
  - [x] Verify priority escalates: 2→3→4→5
  - [x] Work queue item priority updated

### 5.10.3 E2E Tests
- [x] Dashboard shows new error proposal (Playwright tests created)
  - [x] Real-time update on error generation
  - [x] User can approve proposal
  - [x] Proposal moves to work queue
  - [x] User can reject proposal
  - [x] Proposal archived

## Phase 5.11: Documentation

### 5.11.1 Update CLAUDE.md
- [x] Add section on error automation
- [x] Document error proposal generation
- [x] Document error priority escalation
- [x] Document API endpoints
- [x] Document dashboard features
- [x] Document testing coverage
- [x] Document key files and configuration

### 5.11.2 Inline Documentation
- [x] JSDoc on error analysis functions (already documented)
- [x] Comments on proposal generation logic (already documented)

## Summary

**Subtasks**: ~50
**Estimated Timeline**: 1 week
**Dependencies**: Change 1, 2, 3 complete (Change 4 optional but helpful)

**Critical Path**:
1. Error analysis utilities (5.3)
2. Proposal generator (5.3)
3. Failure watcher (5.4)
4. Work queue integration (5.6)
5. Error router (5.8)
6. Dashboard (5.9)
7. Testing (5.10)
