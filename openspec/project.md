# Project Context

## Purpose

Personal dotfiles and homelab infrastructure automation for macOS and Arch Linux environments. This repository manages:

1. **Mac Development Environment** (`/mac`) - macOS dotfiles, Homebrew packages, system configuration, and terminal setup
2. **Homelab Stack** (`/homelab`) - Docker-based self-hosted services for Arch Linux server with automated deployment
3. **Homelab Services** (`/homelab-services`) - Better-T-Stack monorepo with type-safe web applications for CI/CD and test management

**Key Goals:**
- Reproducible development environment setup
- Self-hosted infrastructure with minimal external dependencies
- Automated CI/CD pipeline with GitHub Actions
- Centralized test report aggregation and monitoring
- Type-safe full-stack applications with modern tooling

## Tech Stack

### Mac Environment
- **OS**: macOS (Darwin)
- **Package Manager**: Homebrew
- **Shell**: Zsh with Starship prompt
- **Terminal**: WezTerm
- **Configuration**: Dotfiles-based setup

### Homelab Infrastructure
- **OS**: Arch Linux
- **Containerization**: Docker + Docker Compose
- **Reverse Proxy**: Traefik (dynamic routing, TLS)
- **CI/CD**: GitHub Actions (self-hosted runners)
- **Networking**: Two isolated Docker networks (homelab: 172.20.0.0/16, media: 172.21.0.0/16)
- **DNS**: AdGuard Home
- **Home Automation**: Home Assistant
- **PaaS**: Coolify

### Homelab Services (Better-T-Stack Monorepo)
- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript (strict mode)
- **API Layer**: tRPC (type-safe client-server communication)
- **Database**: PostgreSQL with Drizzle ORM
- **Package Manager**: Bun (monorepo workspace)
- **Styling**: Tailwind CSS + ShadCN UI
- **Forms**: react-hook-form + Zod validation
- **Testing**: Playwright (E2E), Vitest (unit tests)
- **Real-time**: tRPC subscriptions with EventEmitter

### Applications
1. **Claude Agent Web** (port 3002) - Claude Code session management with unified work dashboard
2. **Playwright Server** (port 3000) - Test report aggregation and visualization

## Project Conventions

### Code Style
- **TypeScript**: Strict mode enabled, no implicit any
- **Formatting**: Prettier with 2-space indentation
- **Naming**:
  - camelCase for functions/variables
  - PascalCase for components/types
  - kebab-case for file names
  - SCREAMING_SNAKE_CASE for constants
- **Imports**: Absolute imports via `@/` alias
- **Comments**: JSDoc for public APIs, inline comments for complex logic

### Architecture Patterns

#### Homelab
- **Service Isolation**: Separate Docker Compose files per service category (compose/*.yml)
- **Configuration Management**: Environment variables via .env (auto-generated by wizard)
- **State Tracking**: `.setup_state` file for resumable wizard operations
- **Network Segmentation**: Core infrastructure vs. media services isolation
- **Secrets Management**: .env files excluded from version control

#### Homelab Services (Monorepo)
- **Monorepo Structure**:
  - `apps/` - Next.js applications
  - `packages/` - Shared libraries (api, db, ui, config)
  - `tooling/` - Build configuration (eslint, typescript, tailwind)
- **API Design**: tRPC routers with queries, mutations, subscriptions
- **Database Access**: Drizzle ORM with type-safe queries
- **Component Library**: ShadCN UI components with Tailwind theming
- **State Management**: React Query (via tRPC) for server state
- **Real-time Updates**: tRPC subscriptions for live data

### Testing Strategy

#### E2E Testing (Playwright)
- **Location**: `apps/*/e2e/*.spec.ts`
- **Naming**: Descriptive test names matching user workflows
- **Coverage**: Critical user paths, dashboard interactions, real-time features
- **CI Integration**: Runs on GitHub Actions, reports stored in artifacts
- **Failure Handling**: Auto-generates OpenSpec proposals via FailureWatcher

#### Unit Testing (Vitest)
- **Location**: `packages/*/src/**/__tests__/*.test.ts`
- **Naming**: Mirror source file structure
- **Coverage**: Utilities, services, business logic
- **Mocking**: Minimal mocking, prefer integration-style tests

#### Integration Testing
- **Database Tests**: Use test database with Drizzle migrations
- **API Tests**: tRPC caller pattern for type-safe testing
- **Service Tests**: Full workflow simulation with real dependencies

### Git Workflow

#### Branch Strategy
- **Main Branch**: `main` (protected, production-ready)
- **Feature Branches**: Not typically used (direct commits to main)
- **Deployment**: CI/CD triggers on push to main

#### Commit Conventions
- **Format**: Imperative mood, concise (1-2 sentences)
- **Focus**: "Why" over "what"
- **Examples**:
  - `Add unified work dashboard with drag-and-drop prioritization`
  - `Fix type error in error-analysis utility`
  - `Update deployment orchestration to handle permission errors`
- **Auto-commit Footer**:
  ```
  ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

  Co-Authored-By: Claude <noreply@anthropic.com>
  ```

#### Pull Request Workflow
- **Creation**: Use `gh pr create` via Bash tool
- **Title**: Descriptive, imperative mood
- **Body**: Summary bullets, test plan checklist
- **Footer**: Auto-generated Claude Code attribution

### OpenSpec Workflow

#### Creating Proposals
1. Use `/openspec:proposal` to scaffold new changes
2. Required sections: Why, What Changes, Impact
3. Strict validation via `openspec validate --strict`
4. Tasks checklist in tasks.md

#### Applying Changes
1. Approve proposal via dashboard (`http://localhost:3002/dashboard`)
2. Assign to session or let master agent spawn worker
3. Worker executes tasks and transitions spec through lifecycle
4. User validates completed work and marks as applied

#### Lifecycle States
- **proposing** â†’ **approved** â†’ **assigned** â†’ **in_progress** â†’ **review** â†’ **applied** â†’ **archived**

#### File Structure
```
openspec/
â”œâ”€â”€ project.md (this file)
â”œâ”€â”€ specs/ (reference documentation)
â””â”€â”€ changes/
    â”œâ”€â”€ active/ (current proposals)
    â””â”€â”€ archive/ (completed specs)
```

## Domain Context

### Self-Hosted Infrastructure
- All services run on local Arch Linux server
- No cloud dependencies (except GitHub for CI/CD)
- Dynamic DNS for external access via Traefik
- Local network access via AdGuard Home DNS

### CI/CD Automation
- GitHub Actions runners self-hosted on Arch Linux
- Deployment triggered by push to main
- Streamlined script: `homelab/scripts/deploy-ci-streamlined.sh`
- Permission handling automated in deployment scripts

### Test Report Aggregation
- Playwright Server collects reports from CI artifacts
- Failure detection via polling (30-second interval)
- Auto-generation of OpenSpec proposals from failures
- Priority escalation based on recurrence

### Error-to-Spec Pipeline
1. Test fails in CI
2. FailureWatcher detects failure
3. Error classification (type-error, assertion-failure, etc.)
4. Auto-generate OpenSpec proposal with tasks
5. Priority assignment (1-5 based on classification)
6. User approves â†’ enters work queue
7. Worker agent executes fix
8. User validates â†’ spec applied

## Important Constraints

### Technical Constraints
- **Homelab Hardware**: Single Arch Linux server (limited resources)
- **Network**: Self-hosted, no external cloud services
- **Database**: Single PostgreSQL instance shared across apps
- **Docker Networks**: Fixed IP ranges (172.20.0.0/16, 172.21.0.0/16)
- **Ports**: 3000 (Playwright Server), 3002 (Claude Agent Web)

### Workflow Constraints
- **OpenSpec Required**: New capabilities/architecture changes must use `/openspec:proposal`
- **Dashboard Approval**: All specs require user approval before work starts
- **Wizard State**: Homelab setup wizard must complete before manual commands
- **Git Hooks**: Respect pre-commit hooks, never use --no-verify
- **Documentation**: Service changes require corresponding docs updates

### Development Constraints
- **Type Safety**: No `any` types, strict TypeScript enabled
- **Monorepo**: Changes must work across workspace packages
- **Real-time**: tRPC subscriptions must handle cleanup on unmount
- **Testing**: Critical paths require E2E coverage
- **Commit Attribution**: Always include Claude Code footer

## External Dependencies

### GitHub Services
- **GitHub Actions**: CI/CD pipeline execution
- **GitHub API**: PR creation, issue tracking via `gh` CLI
- **GitHub Container Registry**: Not currently used (Docker Hub for images)

### Docker Images
- **Traefik**: traefik:latest
- **AdGuard Home**: adguard/adguardhome:latest
- **Home Assistant**: ghcr.io/home-assistant/home-assistant:stable
- **PostgreSQL**: postgres:16-alpine
- **Coolify**: coollabsio/coolify:latest

### Development Tools
- **Homebrew**: macOS package installation
- **Bun**: Package management, monorepo workspaces
- **Playwright**: Browser automation, E2E testing
- **Drizzle Kit**: Database migrations

### Monitoring & Observability
- **AdGuard Home**: DNS query logging
- **Traefik Dashboard**: Routing and middleware monitoring
- **Playwright Reports**: Test execution history
- **Docker Logs**: Service output via `docker compose logs`

## Key Entry Points

### Homelab Management
- **Setup**: `homelab/homelab.sh` (interactive wizard)
- **Deployment**: `homelab/scripts/deploy-ci-streamlined.sh` (CI script)
- **Configuration**: `homelab/docker-compose.yml` (main orchestrator)

### Mac Setup
- **Installer**: `mac/install.sh` (interactive setup)

### Homelab Services
- **Claude Agent Web**: `apps/claude-agent-web/src/app/(dashboard)/dashboard/page.tsx`
- **Playwright Server**: `apps/playwright-server/src/app/api/upload/route.ts`
- **API Layer**: `packages/api/src/router/` (tRPC routers)
- **Database**: `packages/db/src/schema/` (Drizzle schemas)

## Documentation References

- **Main Index**: [docs/INDEX.md](../docs/INDEX.md)
- **OpenSpec Specs**: [openspec/specs/](./specs/)
- **Monorepo Docs**: [homelab-services/docs/INDEX.md](../homelab-services/docs/INDEX.md)
- **CLAUDE.md**: [Project instructions](../CLAUDE.md)
